<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">
<head>
    <meta charset="UTF-8">
    <title layout:fragment="title">주문하기</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://js.tosspayments.com/v2/standard"></script>
</head>
<body>
<div layout:fragment="content">
    <div class="container mt-4" style="max-width: 1200px;">
        <h2 class="mb-4">주문하기</h2>
        
        <!-- 에러/성공 메시지 -->
        <div th:if="${errorMessage}" class="alert alert-danger" role="alert">
            <span th:text="${errorMessage}"></span>
        </div>
        
        <!-- 주문 상품 정보 -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">주문 상품</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>상품명</th>
                                <th>수량</th>
                                <th>단가</th>
                                <th>총 금액</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="item : ${cartItems}">
                                <td th:text="${item.bookTitle}">Spring Boot 완벽 가이드</td>
                                <td th:text="${item.quantity}">1</td>
                                <td th:text="${#numbers.formatCurrency(item.price)}">25,000원</td>
                                <td th:text="${#numbers.formatCurrency(item.totalPrice)}">25,000원</td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr class="table-info">
                                <th colspan="3">총 주문 금액</th>
                                <th th:text="${#numbers.formatCurrency(totalAmount)}">61,000원</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- 주문 정보 입력 폼 -->
        <form th:action="@{/order}" th:object="${orderRequest}" method="post">
            <!-- 숨겨진 주문 상품 정보 -->
            <div th:each="item, itemStat : ${cartItems}">
                <input type="hidden" th:name="|orderItems[${itemStat.index}].bookId|" th:value="${item.bookId}"/>
                <input type="hidden" th:name="|orderItems[${itemStat.index}].bookTitle|" th:value="${item.bookTitle}"/>
                <input type="hidden" th:name="|orderItems[${itemStat.index}].quantity|" th:value="${item.quantity}"/>
                <input type="hidden" th:name="|orderItems[${itemStat.index}].price|" th:value="${item.price}"/>
                <input type="hidden" th:name="|orderItems[${itemStat.index}].totalPrice|" th:value="${item.totalPrice}"/>
            </div>
            <input type="hidden" th:field="*{totalAmount}" th:value="${totalAmount}"/>
            
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">배송 정보</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="recipientName" class="form-label">받는 사람</label>
                            <input type="text" class="form-control" id="recipientName" 
                                   th:field="*{recipientName}" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="recipientPhone" class="form-label">연락처</label>
                            <input type="tel" class="form-control" id="recipientPhone" 
                                   th:field="*{recipientPhone}" placeholder="010-1234-5678" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="shippingAddress" class="form-label">배송 주소</label>
                        <input type="text" class="form-control" id="shippingAddress" 
                               th:field="*{shippingAddress}" required>
                    </div>
                    <div class="mb-3">
                        <label for="orderMessage" class="form-label">배송 요청사항</label>
                        <textarea class="form-control" id="orderMessage" rows="3" 
                                  th:field="*{orderMessage}" placeholder="배송 시 요청사항을 입력해주세요 (선택)"></textarea>
                    </div>
                </div>
            </div>
            
            <!-- 결제 정보 -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0">결제 정보</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>결제 금액</h6>
                            <p class="fs-4 text-primary fw-bold" th:text="${#numbers.formatCurrency(totalAmount)}">61,000원</p>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">결제 방법</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="paymentMethod" 
                                       id="creditCard" value="creditCard" checked>
                                <label class="form-check-label" for="creditCard">
                                    신용카드
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="paymentMethod" 
                                       id="bankTransfer" value="bankTransfer">
                                <label class="form-check-label" for="bankTransfer">
                                    계좌이체
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 주문 버튼 -->
            <div class="d-flex justify-content-between mt-4">
                <a href="/cart" class="btn btn-secondary">장바구니로 돌아가기</a>
<!--                <button type="submit" class="btn btn-primary btn-lg" onclick="requestPayment()">주문하기</button>-->
            </div>
        </form>
        <button class="button" style="margin-top: 30px" onclick="requestPayment()">결제하기</button>
    </div>
</div>
<script>
    const amount = {
        currency: "KRW",
        value: 50000,
    };

    let selectedPaymentMethod = null;

    function selectPaymentMethod(method) {
        if (selectedPaymentMethod != null) {
            document.getElementById(selectedPaymentMethod).style.backgroundColor = "#ffffff";
        }

        selectedPaymentMethod = method;

        document.getElementById(selectedPaymentMethod).style.backgroundColor = "rgb(229 239 255)";
    }

    // ------  SDK 초기화 ------
    // TODO: clientKey는 개발자센터의 API 개별 연동 키 > 결제창 연동에 사용하려할 MID > 클라이언트 키로 바꾸세요.
    // TODO: server.js 의 secretKey 또한 결제위젯 연동 키가 아닌 API 개별 연동 키의 시크릿 키로 변경해야 합니다.
    // TODO: 구매자의 고유 아이디를 불러와서 customerKey로 설정하세요. 이메일・전화번호와 같이 유추가 가능한 값은 안전하지 않습니다.
    // @docs https://docs.tosspayments.com/sdk/v2/js#토스페이먼츠-초기화
    const clientKey = "test_ck_E92LAa5PVb9MbzjGQgjY37YmpXyJ";
    const customerKey = generateRandomString();
    const tossPayments = TossPayments(clientKey);
    // 회원 결제
    // @docs https://docs.tosspayments.com/sdk/v2/js#tosspaymentspayment
    const payment = tossPayments.payment({
        customerKey,
    });
    // 비회원 결제
    // const payment = tossPayments.payment({customerKey: TossPayments.ANONYMOUS});

    // ------ '결제하기' 버튼 누르면 결제창 띄우기 ------
    // @docs https://docs.tosspayments.com/sdk/v2/js#paymentrequestpayment
    async function requestPayment() {
        // 결제를 요청하기 전에 orderId, amount를 서버에 저장하세요.
        // 결제 과정에서 악의적으로 결제 금액이 바뀌는 것을 확인하는 용도입니다.
        switch (selectedPaymentMethod) {
            case "CARD":
                await payment.requestPayment({
                    method: "CARD", // 카드 및 간편결제
                    amount,
                    orderId: generateRandomString(),
                    orderName: "토스 티셔츠 외 2건",
                    successUrl: window.location.origin + "/payment/success.html", // 결제 요청이 성공하면 리다이렉트되는 URL
                    failUrl: window.location.origin + "/fail.html", // 결제 요청이 실패하면 리다이렉트되는 URL
                    customerEmail: "customer123@gmail.com",
                    customerName: "김토스",
                    // 가상계좌 안내, 퀵계좌이체 휴대폰 번호 자동 완성에 사용되는 값입니다. 필요하다면 주석을 해제해 주세요.
                    // customerMobilePhone: "01012341234",
                    card: {
                        useEscrow: false,
                        flowMode: "DEFAULT",
                        useCardPoint: false,
                        useAppCardOnly: false,
                    },
                });
            case "TRANSFER":
                await payment.requestPayment({
                    method: "TRANSFER", // 계좌이체 결제
                    amount,
                    orderId: generateRandomString(),
                    orderName: "토스 티셔츠 외 2건",
                    successUrl: window.location.origin + "/payment/success.html",
                    failUrl: window.location.origin + "/fail.html",
                    customerEmail: "customer123@gmail.com",
                    customerName: "김토스",
                    // 가상계좌 안내, 퀵계좌이체 휴대폰 번호 자동 완성에 사용되는 값입니다. 필요하다면 주석을 해제해 주세요.
                    // customerMobilePhone: "01012341234",
                    transfer: {
                        cashReceipt: {
                            type: "소득공제",
                        },
                        useEscrow: false,
                    },
                });
            case "VIRTUAL_ACCOUNT":
                await payment.requestPayment({
                    method: "VIRTUAL_ACCOUNT", // 가상계좌 결제
                    amount,
                    orderId: generateRandomString(),
                    orderName: "토스 티셔츠 외 2건",
                    successUrl: window.location.origin + "/payment/success.html",
                    failUrl: window.location.origin + "/fail.html",
                    customerEmail: "customer123@gmail.com",
                    customerName: "김토스",
                    // 가상계좌 안내, 퀵계좌이체 휴대폰 번호 자동 완성에 사용되는 값입니다. 필요하다면 주석을 해제해 주세요.
                    // customerMobilePhone: "01012341234",
                    virtualAccount: {
                        cashReceipt: {
                            type: "소득공제",
                        },
                        useEscrow: false,
                        validHours: 24,
                    },
                });
            case "MOBILE_PHONE":
                await payment.requestPayment({
                    method: "MOBILE_PHONE", // 휴대폰 결제
                    amount,
                    orderId: generateRandomString(),
                    orderName: "토스 티셔츠 외 2건",
                    successUrl: window.location.origin + "/payment/success.html",
                    failUrl: window.location.origin + "/fail.html",
                    customerEmail: "customer123@gmail.com",
                    customerName: "김토스",
                    // 가상계좌 안내, 퀵계좌이체 휴대폰 번호 자동 완성에 사용되는 값입니다. 필요하다면 주석을 해제해 주세요.
                    // customerMobilePhone: "01012341234",
                });
            case "CULTURE_GIFT_CERTIFICATE":
                await payment.requestPayment({
                    method: "CULTURE_GIFT_CERTIFICATE", // 문화상품권 결제
                    amount,
                    orderId: generateRandomString(),
                    orderName: "토스 티셔츠 외 2건",
                    successUrl: window.location.origin + "/payment/success.html",
                    failUrl: window.location.origin + "/fail.html",
                    customerEmail: "customer123@gmail.com",
                    customerName: "김토스",
                    // 가상계좌 안내, 퀵계좌이체 휴대폰 번호 자동 완성에 사용되는 값입니다. 필요하다면 주석을 해제해 주세요.
                    // customerMobilePhone: "01012341234",
                });
            case "FOREIGN_EASY_PAY":
                await payment.requestPayment({
                    method: "FOREIGN_EASY_PAY", // 해외 간편결제
                    amount: {
                        value: 100,
                        currency: "USD",
                    },
                    orderId: generateRandomString(),
                    orderName: "토스 티셔츠 외 2건",
                    successUrl: window.location.origin + "/payment/success.html",
                    failUrl: window.location.origin + "/fail.html",
                    customerEmail: "customer123@gmail.com",
                    customerName: "김토스",
                    // 가상계좌 안내, 퀵계좌이체 휴대폰 번호 자동 완성에 사용되는 값입니다. 필요하다면 주석을 해제해 주세요.
                    // customerMobilePhone: "01012341234",
                    foreignEasyPay: {
                        provider: "PAYPAL",
                        country: "KR",
                    },
                });
        }
    }

    async function requestBillingAuth() {
        await payment.requestBillingAuth({
            method: "CARD", // 자동결제(빌링)은 카드만 지원합니다
            successUrl: window.location.origin + "/payment/billing.html", // 요청이 성공하면 리다이렉트되는 URL
            failUrl: window.location.origin + "/fail.html",
            customerEmail: "customer123@gmail.com", // 요청이 실패하면 리다이렉트되는 URL
            customerName: "김토스",
        });
    }

    function generateRandomString() {
        return window.btoa(Math.random()).slice(0, 20);
    }
</script>
</body>
</html>